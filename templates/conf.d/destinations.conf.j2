#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}

{#
{% for k, v in syslog_logs.items() %}
  {% if loop.first %}
# HOST SPECIFIC DESTINATIONS
  {% endif %}

destination d_{{ k }}  {
  # OBSOLETE
  file(
    "/var/log/{{ v.file_name | default(k + '.log', true) }}"
  {% if v.use_template | default('true') and
        v.template | default('tmpl') | string | length > 0 %}
    template({{ v.template | default('tmpl') }})
  {% endif %}
  );
};

{% endfor %}
#}

{% if syslog_destinations is defined and
      syslog_destinations | count > 0 %}
  {% for k, v in syslog_destinations.items() %}
    {% if loop.first %}
# HOST SPECIFIC DESTINATIONS
    {% endif %}
destination d_{{ k }}  {
    {# file #}
    {% if v.file_name is defined and
          v.file_name | string | length > 0 %}
  file(
    "/var/log/{{ v.file_name | default(k + '.log', true) }}"
  {% if v.use_template | default('true') and
        v.template | default('tmpl') | string | length > 0 %}
    template({{ v.template | default('tmpl') }})
  {% endif %}
  );
    {% endif %}
    {# syslog-ng #}
    {% if v.network is defined and
          v.network | string | length > 0 %}
      {% set _transport, _port = v | template_syslog %}
  network(
    "{{ v.network }}"
    transport("{{ _transport }}")
    port({{ _port }})
  );
    {% endif %}
    {# syslog #}
    {% if v.syslog is defined and
          v.syslog | string | length > 0 %}
      {% set _transport, _port = v | template_syslog %}
  syslog(
    "{{ v.syslog }}"
    transport("{{ _transport }}")
    port({{ _port }})
      {% if v.transport == "tls" %}
    {#
      https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.18/administration-guide/58#TOPIC-1044108
    #}
    tls(
      {#
        Accepted values: optional-trusted | optional-untrusted | required-trusted | required-untrusted | yes | no
      #}
      peer-verify(required-trusted)
      ca-dir('/opt/syslog-ng/etc/syslog-ng/keys/ca.d/')
      key-file('/opt/syslog-ng/etc/syslog-ng/keys/client_key.pem')
      cert-file('/opt/syslog-ng/etc/syslog-ng/keys/client_certificate.pem')
    )
      {% endif %}
  );
    {% endif %}
};

  {% endfor %}
{% endif %}

# COMMON DESTINATIONS
{% if syslog_hardened %}
destination d_grsec {
  file("/var/log/grsec.log"
  template(tmpl));
};

destination d_pax {
  file("/var/log/pax.log"
  template(tmpl));
};

{% endif %}
destination d_console {
  usertty("root");
};

destination d_console_all {
  file("/dev/tty12"
  template(tmpl));
};
